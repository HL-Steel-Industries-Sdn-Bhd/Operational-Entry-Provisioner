<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operational Entry Provisioner (OEP)</title>
<style>
    :root {
        --primary-blue: #667eea;
        --secondary-purple: #764ba2;
        --light-blue: #e3f2fd;
        --light-red: #ffebee;
        --myr-blue: #bbdefb;
        --sgd-red: #ffcdd2;
        --success-green: #4caf50;
        --warning-orange: #ff9800;
        --error-red: #f44336;
        --rd-green: #81c784;
        --stock-blue: #64b5f6;
        --sample-purple: #ba68c8; /* Êñ∞Â¢ûÔºöSample È¢úËâ≤ */
    }
    
    * { 
        box-sizing: border-box; 
        margin:0; 
        padding:0; 
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    body { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        min-height:100vh; 
        display:flex; 
        justify-content:center; 
        align-items:center; 
        padding:20px; 
    }
    
    .main-container {
        display: flex;
        max-width: 1400px;
        width: 100%;
        gap: 20px;
        align-items: flex-start;
    }
    
    .left-panel {
        flex: 0 0 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 25px;
        height: fit-content;
    }
    
    .center-panel {
        flex: 1;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 30px;
        min-width: 0;
    }
    
    .right-panel {
        flex: 0 0 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 25px;
        height: fit-content;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    h1 { 
        color:#333; 
        text-align:center; 
        margin-bottom:25px; 
        font-size:28px; 
        font-weight:600; 
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-blue);
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    /* QR Scanner Styles */
    #qrScanner {
        width: 100%;
        height: 200px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }
    
    #scannerVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.9);
        z-index: 2;
    }
    
    .scanner-overlay.hidden {
        display: none;
    }
    
    #adminWelcome {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, var(--light-blue) 0%, #e8f5e9 100%);
        border-radius: 8px;
        margin-top: 15px;
        display: none;
    }
    
    .welcome-text {
        font-size: 16px;
        color: #333;
    }
    
    .admin-name {
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-blue);
        margin-top: 5px;
    }
    
    /* Form Styles */
    .date-info { 
        background:#f8f9fa; 
        border-radius:8px; 
        padding:15px; 
        margin-bottom:25px; 
        text-align:center; 
        border-left:4px solid var(--primary-blue); 
    }
    
    .current-month { 
        font-size:18px; 
        color:var(--primary-blue); 
        font-weight:600; 
    }
    
    .form-grid { 
        display:grid; 
        grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); 
        gap:20px; 
        margin-bottom:25px; 
    }
    
    .form-group { 
        display:flex; 
        flex-direction:column; 
    }
    
    label { 
        font-weight:500; 
        color:#555; 
        margin-bottom:6px; 
        font-size:14px; 
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .required::after {
        content: " *";
        color: var(--error-red);
    }
    
    input, select { 
        padding:12px; 
        border:1px solid #ddd; 
        border-radius:6px; 
        font-size:14px; 
        transition:border-color 0.3s; 
    }
    
    input:focus, select:focus { 
        outline:none; 
        border-color:var(--primary-blue); 
        box-shadow:0 0 0 2px rgba(102,126,234,0.1); 
    }
    
    .full-width { 
        grid-column:1 / -1; 
    }
    
    /* Special SO types */
    .rd-field {
        background-color: rgba(129, 199, 132, 0.1) !important;
        border-left: 4px solid var(--rd-green) !important;
    }
    
    .stock-field {
        background-color: rgba(100, 181, 246, 0.1) !important;
        border-left: 4px solid var(--stock-blue) !important;
    }
    
    .sample-field {
        background-color: rgba(186, 104, 200, 0.1) !important;
        border-left: 4px solid var(--sample-purple) !important;
    }
    
    .auto-item-info {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        padding: 5px 8px;
        background: #f5f5f5;
        border-radius: 4px;
        border-left: 3px solid var(--success-green);
    }
    
    /* Currency input styles */
    .currency-group {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 6px;
        overflow: hidden;
    }
    
    .currency-prefix {
        padding: 12px 15px;
        background: #f5f5f5;
        font-weight: 600;
        color: #555;
        border-right: 1px solid #ddd;
        min-width: 60px;
        text-align: center;
    }
    
    .currency-input {
        flex: 1;
        border: none !important;
        padding-left: 12px;
    }
    
    .myr-input {
        background-color: var(--myr-blue);
    }
    
    .sgd-input {
        background-color: var(--sgd-red);
    }
    
    .currency-reminder {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        padding: 8px;
        background: #f9f9f9;
        border-radius: 4px;
        border-left: 3px solid var(--warning-orange);
    }
    
    /* Date picker styles */
    .date-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .date-input {
        flex: 1;
    }
    
    .calendar-button {
        padding: 12px 15px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        color: #555;
        font-weight: 500;
    }
    
    .calendar-button:hover {
        background: #e9ecef;
    }
    
    /* Button Styles */
    .button-container { 
        display:flex; 
        justify-content:center; 
        gap:15px; 
        margin-top:30px; 
    }
    
    button { 
        padding:14px 30px; 
        border:none; 
        border-radius:6px; 
        font-size:16px; 
        font-weight:600; 
        cursor:pointer; 
        transition:all 0.3s; 
    }
    
    .submit-btn { 
        background:linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-purple) 100%); 
        color:white; 
        min-width:200px; 
    }
    
    .submit-btn:hover:not(:disabled) { 
        transform:translateY(-2px); 
        box-shadow:0 5px 15px rgba(102,126,234,0.4); 
    }
    
    .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .submit-btn:active { 
        transform:translateY(0); 
    }
    
    .reset-btn { 
        background:#f8f9fa; 
        color:#666; 
        border:1px solid #ddd; 
    }
    
    .reset-btn:hover { 
        background:#e9ecef; 
    }
    
    /* QR Display Styles */
    #qrDisplay {
        width: 250px;
        height: 250px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 10px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    #qrCodeCanvas {
        width: 100%;
        height: 100%;
    }
    
    #qrPlaceholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
        background: white;
    }
    
    .download-btn {
        background: linear-gradient(135deg, var(--success-green) 0%, #2e7d32 100%);
        color: white;
        padding: 12px 30px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        margin-top: 10px;
        transition: all 0.3s;
    }
    
    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76,175,80,0.4);
    }
    
    .download-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }
    
    /* Status Message Styles */
    .status-message { 
        margin-top:20px; 
        padding:12px; 
        border-radius:6px; 
        text-align:center; 
        display:none; 
    }
    
    .success { 
        background:#d4edda; 
        color:#155724; 
        border:1px solid #c3e6cb; 
    }
    
    .error { 
        background:#f8d7da; 
        color:#721c24; 
        border:1px solid #f5c6cb; 
    }
    
    .loading { 
        background:#fff3cd; 
        color:#856404; 
        border:1px solid #ffeaa7; 
    }
    
    .info { 
        background:#d1ecf1; 
        color:#0c5460; 
        border:1px solid #bee5eb; 
    }
    
    /* Character Counter */
    .char-counter {
        font-size: 12px;
        color: #666;
        text-align: right;
        margin-top: 5px;
    }
    
    .char-counter.warning {
        color: var(--warning-orange);
    }
    
    .char-counter.error {
        color: var(--error-red);
        font-weight: bold;
    }
    
    /* Validation styles */
    .valid {
        border-color: var(--success-green) !important;
    }
    
    .invalid {
        border-color: var(--error-red) !important;
    }
    
    /* Format info styles */
    .format-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 5px;
    }
    
    .format-text {
        font-size: 12px;
        color: #666;
    }
    
    .combined-counter {
        font-size: 12px;
        color: #666;
    }
    
    .combined-counter.warning {
        color: var(--warning-orange);
    }
    
    .combined-counter.error {
        color: var(--error-red);
        font-weight: bold;
    }
    
    /* Modal Styles */
    .duplicate-highlight {
        border-color: var(--error-red) !important;
        box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.1) !important;
    }
    
    .trailing-space-highlight {
        border-color: var(--warning-orange) !important;
        box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.1) !important;
    }
    
    /* Force submit indicator */
    .force-submitted {
        position: relative;
    }
    
    .force-submitted::after {
        content: "‚ö†Ô∏è";
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 16px;
        color: var(--error-red);
    }
    
    /* Mobile Responsive */
    @media (max-width: 1200px) {
        .main-container {
            flex-direction: column;
        }
        
        .left-panel, .center-panel, .right-panel {
            flex: none;
            width: 100%;
        }
    }
    
    @media (max-width: 600px){ 
        .form-grid{grid-template-columns:1fr;} 
        .container{padding:20px;} 
        .button-container{flex-direction:column;} 
    }
</style>
<!-- Include jsQR library for QR scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- Include QRCode library for generating QR codes - FIXED URL -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
<div class="main-container">
    <!-- Left Panel: Admin QR Scanner -->
    <div class="left-panel">
        <h2>üîç Admin Authentication</h2>
        <div class="section-title">Scan Your Personal QR Code</div>
        
        <div id="qrScanner">
            <div id="scannerOverlay" class="scanner-overlay">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                    <p style="color: #666; margin-bottom: 15px;">Click to start camera for QR scanning</p>
                    <button id="startScanner" onclick="startQRScanner()" style="padding: 10px 20px; background: var(--primary-blue); color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Start Camera
                    </button>
                </div>
            </div>
            <video id="scannerVideo" playsinline></video>
            <canvas id="scannerCanvas" style="display: none;"></canvas>
        </div>
        
        <button id="stopScanner" onclick="stopQRScanner()" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; display: none;">
            Stop Scanner
        </button>
        
        <div id="adminWelcome">
            <div class="welcome-text">Welcome!</div>
            <div class="admin-name" id="adminNameDisplay"></div>
            <div style="margin-top: 10px; font-size: 14px; color: #666;">
                You are authenticated as Admin
            </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; font-size: 14px; color: #666;">
            <strong>Note:</strong> Scan your personal QR code to authenticate as Admin. The QR should be from your personal employee page.
        </div>
    </div>
    
    <!-- Center Panel: Form Entry -->
    <div class="center-panel">
        <h1>üìã Operational Entry Provisioner (OEP)</h1>
        
        <!-- Date Info -->
        <div class="date-info">
            <div class="current-month" id="currentMonth"></div>
            <div style="margin-top:8px; color:#666; font-size:14px;" id="workflowInfo">Data will be saved to the corresponding Work Flow Google Sheet</div>
        </div>
        
        <!-- Hidden iframe for form submission -->
        <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
        
        <!-- Main Form -->
        <form id="salesForm" target="hidden_iframe" method="post">
            <div class="form-grid">
                <!-- Sales Order No. -->
                <div class="form-group">
                    <label for="salesOrder" class="required">Sales Order No.</label>
                    <input type="text" id="salesOrder" name="salesOrder" required 
                           placeholder="e.g., 009999, 999999 (R&D), 000000 (Stock), or 888888 (Sample)"
                           onblur="validateSalesOrderOnBlur(); checkSpecialItemNo(); validateSalesOrderTrailingSpace(this, true)"
                           oninput="updateCombinedCounter(); validateSalesOrderTrailingSpace(this)"
                           onchange="handleSalesOrderType()">
                    <div class="format-info">
                        <div class="format-text">
                            Format: 6 digits + optional letter<br>
                            Special: 999999=R&D, 000000=Stock, 888888=Sample
                        </div>
                        <div class="combined-counter" id="salesOrderCombinedCounter"></div>
                    </div>
                    <div id="soTypeInfo" class="auto-item-info" style="display: none;"></div>
                </div>
                
                <!-- Item No. -->
                <div class="form-group">
                    <label for="itemNo" class="required">Item No.</label>
                    <input type="text" id="itemNo" name="itemNo" required 
                           placeholder="e.g., 23B"
                           onblur="validateItemNoOnBlur(); validateItemNoTrailingSpace(this, true)"
                           oninput="updateCombinedCounter(); validateItemNoTrailingSpace(this)">
                    <div class="format-info">
                        <div class="format-text">
                            Format: Numbers or Numbers + 1 letter (e.g., 100 or 100A)
                        </div>
                        <div class="combined-counter" id="itemNoCombinedCounter"></div>
                    </div>
                    <div id="autoItemInfo" class="auto-item-info" style="display: none;"></div>
                </div>
                
                <!-- Customer Name -->
                <div class="form-group">
                    <label for="customerName" class="required">Customer Name</label>
                    <input type="text" id="customerName" name="customerName" required 
                           placeholder="Enter customer full name"
                           oninput="updateCombinedCounter(); validateTrailingSpaces(this, 'Customer Name')"
                           onblur="validateTrailingSpaces(this, 'Customer Name', true)">
                    <div class="format-info">
                        <div class="format-text"></div>
                        <div class="combined-counter" id="customerNameCombinedCounter"></div>
                    </div>
                </div>
                
                <!-- Customer Short Name -->
                <div class="form-group">
                    <label for="customerShortName" class="required">Customer Short Name</label>
                    <input type="text" id="customerShortName" name="customerShortName" required 
                           placeholder="e.g., ABC123"
                           maxlength="7"
                           oninput="validateShortName()">
                    <div class="char-counter">
                        <span id="shortNameCounter">0</span>/7 characters
                    </div>
                </div>
                
                <!-- Item Name (Main) -->
                <div class="form-group">
                    <label for="itemNameMain" class="required">Item Name (Main)</label>
                    <input type="text" id="itemNameMain" name="itemNameMain" required 
                           placeholder="Enter main item name"
                           oninput="updateCombinedCounter(); validateTrailingSpaces(this, 'Item Name (Main)')"
                           onblur="validateTrailingSpaces(this, 'Item Name (Main)', true)">
                    <div class="format-info">
                        <div class="format-text"></div>
                        <div class="combined-counter" id="itemNameCombinedCounter"></div>
                    </div>
                </div>
                
                <!-- Item Name (Sub) -->
                <div class="form-group">
                    <label for="itemNameSub">Item Name (Sub) - Optional</label>
                    <input type="text" id="itemNameSub" name="itemNameSub" 
                           placeholder="Enter sub item name (if any)">
                </div>
                
                <!-- Dimension -->
                <div class="form-group">
                    <label for="dimension" class="required">Dimension</label>
                    <input type="text" id="dimension" name="dimension" required 
                           placeholder="e.g., 100x200x50 mm">
                </div>
                
                <!-- Quantity -->
                <div class="form-group">
                    <label for="quantity" class="required">Quantity</label>
                    <input type="text" id="quantity" name="quantity" required 
                           placeholder="e.g., 100"
                           onblur="validateQuantityOnBlur()"
                           oninput="updateUnitOptions()">
                    <div class="format-info">
                        <div class="format-text">
                            Format: Numbers only (e.g., 100)
                        </div>
                        <div></div>
                    </div>
                </div>
                
                <!-- Unit of Measurement -->
                <div class="form-group">
                    <label for="unit" class="required">Unit of Measurement</label>
                    <select id="unit" name="unit" required onchange="validateUnit()">
                        <option value="">Select Unit</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                
                <!-- Estimated Delivery Date -->
                <div class="form-group">
                    <label for="estimatedDelivery">Estimated Delivery Date (Optional)</label>
                    <div class="date-input-container">
                        <input type="date" id="estimatedDelivery" name="estimatedDelivery" 
                               class="date-input">
                        <button type="button" class="calendar-button" onclick="openCalendar()">
                            üìÖ Calendar
                        </button>
                    </div>
                </div>
                
                <!-- MYR -->
                <div class="form-group">
                    <label for="myr">MYR (RM)</label>
                    <div class="currency-group">
                        <div class="currency-prefix">RM</div>
                        <input type="number" id="myr" name="myr" 
                               class="currency-input myr-input" 
                               step="0.01" 
                               placeholder="0.00"
                               oninput="validateCurrency()">
                    </div>
                </div>
                
                <!-- SGD -->
                <div class="form-group">
                    <label for="sgd">SGD (S$)</label>
                    <div class="currency-group">
                        <div class="currency-prefix">S$</div>
                        <input type="number" id="sgd" name="sgd" 
                               class="currency-input sgd-input" 
                               step="0.01" 
                               placeholder="0.00"
                               oninput="validateCurrency()">
                    </div>
                </div>
            </div>
            
            <!-- Currency Reminder -->
            <div class="currency-reminder full-width">
                üí° <strong>Important:</strong> Based on customer's country, fill either MYR or SGD box. 
                Enter the <strong>total price</strong> (quantity √ó unit price) directly from Sales Order. 
                Do not convert currency. Only one currency field is required.
            </div>
            
            <!-- Combined Character Counter -->
            <div class="full-width" style="margin-top: 20px;">
                <div class="char-counter" id="combinedCounter">
                    Combined characters (SO + Customer + ItemNo + ItemMain): <span id="combinedChars">0</span>/90
                </div>
            </div>
            
            <!-- Hidden fields -->
            <input type="hidden" id="month" name="month">
            <input type="hidden" id="year" name="year">
            <input type="hidden" id="sheetId" name="sheetId">
            <input type="hidden" id="adminName" name="adminName">
            <input type="hidden" id="adminQR" name="adminQR">
            <input type="hidden" id="timestamp" name="timestamp">
            <input type="hidden" id="generatedQR" name="generatedQR">
            <input type="hidden" id="qrFileName" name="qrFileName">
            <input type="hidden" id="workflowSheetId" name="workflowSheetId">
            <input type="hidden" id="generationLogId" name="generationLogId" value="1c6Z5tr3hsL5nFAt6m_nqB9xluxNxais5LS3dRN0sffY">
            <input type="hidden" id="collectionSheetId" name="collectionSheetId" value="1QJxMVXoIPLIXOOJSzCMquJXu4q1vgRgCyNRKwsxf5TY">
            <input type="hidden" id="qrFolderId" name="qrFolderId" value="1zWm5mGx1WvjhgHALQgNTvdUanPLdhny2">
            
            <div class="button-container">
                <button type="button" class="reset-btn" onclick="resetForm()">Reset Form</button>
                <button type="submit" class="submit-btn" id="submitBtn" onclick="return prepareAndSubmitForm(event)" disabled>
                    Submit Drawing Information
                </button>
            </div>
            <div id="statusMessage" class="status-message"></div>
        </form>
    </div>
    
    <!-- Right Panel: QR Display -->
    <div class="right-panel">
        <h2>üì± Generated QR Code</h2>
        <div class="section-title">Production Worker Access QR</div>
        
        <div id="qrDisplay">
            <canvas id="qrCodeCanvas"></canvas>
            <div id="qrPlaceholder">
                <div style="font-size: 48px; margin-bottom: 10px;">üî≤</div>
                <p style="text-align: center;">QR code will appear here after submission</p>
            </div>
        </div>
        
        <button id="downloadQR" class="download-btn" onclick="downloadQRCode()" disabled>
            ‚¨á Download QR Code
        </button>
        
        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; width: 100%;">
            <div style="font-weight: 600; color: #333; margin-bottom: 10px;">QR Information:</div>
            <div style="font-size: 14px; color: #666; word-break: break-all;" id="qrInfo">
                This QR links production workers to the operational entry form.<br><br>
                URL format: https://hl-steel-industries-sdn-bhd.github.io/Drawing-QR-Template/?H=<br><br>
                <strong>Example:</strong><br>
                Full URL: https://hl-steel-industries-sdn-bhd.github.io/Drawing-QR-Template/?H=U08tODg4ODg4QSsyM0I=
            </div>
        </div>
    </div>
</div>

<!-- Calendar Modal -->
<div id="calendarModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%;">
        <h3 style="margin-bottom: 20px;">Select Estimated Delivery Date</h3>
        <input type="date" id="modalDatePicker" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeCalendar()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                Cancel
            </button>
            <button onclick="applyCalendarDate()" style="padding: 10px 20px; background: var(--primary-blue); color: white; border: none; border-radius: 5px; cursor: pointer;">
                Apply Date
            </button>
        </div>
    </div>
</div>

<!-- Duplicate Confirmation Modal -->
<div id="duplicateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
        <h3 style="margin-bottom: 20px; color: #2c3e50; font-size: 24px;" id="duplicateModalTitle">‚ö†Ô∏è Duplicate Entry Found</h3>
        <p style="margin-bottom: 15px; color: #555; font-size: 16px; line-height: 1.5;" id="duplicateModalMessage">
            The following combination already exists:
        </p>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
            <div><strong>Sales Order No.:</strong> <span id="duplicateSalesOrder" style="color: #e74c3c; font-weight: bold;"></span></div>
            <div><strong>Item No.:</strong> <span id="duplicateItemNo" style="color: #e74c3c; font-weight: bold;"></span></div>
            <div id="duplicateListInfo" style="display: none;"><strong>Found in:</strong> <span id="duplicateListName" style="color: #e74c3c; font-weight: bold;"></span></div>
            <div><strong>Combination:</strong> <span id="duplicateCombination" style="font-weight: bold;"></span></div>
        </div>
        <p style="margin-bottom: 25px; color: #e74c3c; font-weight: bold; font-size: 14px;" id="duplicateNote">
            <span style="font-size: 20px; margin-right: 5px;">‚ìò</span>
            Note: SO numbers with different trailing letters (e.g., 009999 and 009999A) are considered the same.
        </p>
        <p style="margin-bottom: 25px; color: #555; font-size: 14px;">
            Do you want to force submit this entry anyway?
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="forceSubmitEntry()" 
                    style="padding: 12px 40px; background: #2ecc71; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">
                Yes, Submit Anyway
            </button>
            <button onclick="cancelDuplicateSubmission()" 
                    style="padding: 12px 40px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">
                No, Cancel
            </button>
        </div>
    </div>
</div>

<!-- Trailing Space Warning Modal -->
<div id="trailingSpaceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
        <h3 style="margin-bottom: 20px; color: #e67e22; font-size: 24px;">‚ö†Ô∏è Trailing Spaces Detected</h3>
        <p style="margin-bottom: 15px; color: #555; font-size: 16px; line-height: 1.5;" id="trailingSpaceMessage">
            The following fields have trailing spaces:
        </p>
        <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; border-left: 4px solid #e67e22;">
            <ul id="trailingSpaceFields" style="margin: 0; padding-left: 20px;">
                <!-- Fields will be populated here -->
            </ul>
        </div>
        <p style="margin-bottom: 25px; color: #e67e22; font-weight: bold; font-size: 14px;">
            <span style="font-size: 20px; margin-right: 5px;">‚ö†Ô∏è</span>
            Important: Trailing spaces can cause issues in Google Sheets. Please remove them.
        </p>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="autoFixTrailingSpaces()" 
                    style="padding: 12px 40px; background: #3498db; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">
                Auto-Fix Spaces
            </button>
            <button onclick="manualFixTrailingSpaces()" 
                    style="padding: 12px 40px; background: #e67e22; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">
                I'll Fix Manually
            </button>
            <button onclick="forceSubmitWithSpaces()" 
                    style="padding: 12px 40px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; font-size: 16px;">
                Submit Anyway
            </button>
        </div>
    </div>
</div>

<script>
// GAS URL - Will be updated when you deploy
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyUnXboNyoIFEZWd8lG8ue3C8kEHPb_t2UHSckPse212RVv5wkvkZLyIZ4qoOQRqSp0/exec'; // Replace with your GAS web app URL

// Work Flow Google Sheets IDs
const WORKFLOW_SHEETS = {
    '2025-12': '1qXNCBNvO3e8SUxHq8g84ditVSbNRvkw2g1M2C9bWw68',
    '2026-1': '1rO89kIwrjCMzIbIjny8O8nT8kp-WSm6GDZH8CPQZysg',
    '2026-2': '1H6koj_rbNziPupTsg0QrrWhtk6O-Lp7uZ-GQeQStVoE',
    '2026-3': '1age5UUoTlJ1pm1RfX2PwFUTivWLHpnewpGdKQwtxdOs',
    '2026-4': '1Td4FF4EfsoKuWjqqd8ARZbzCuTBHvbswO1vV0xb0sJg',
    '2026-5': '1By25HTqcgFHlw2O-13257GNL1RTQTCJyHHdh3vJNBFM',
    '2026-6': '180fhGeiXT3AotL_riFebt-_2qPb3jitTSAtZFPRInMc',
    '2026-7': '1TYZTj9EJKQeJn1ODsl3Tlwvrd8WXCh5mu93dLiLg0gA',
    '2026-8': '1WDeZJQ1k0QvDK99ucCxgIn_qG9WcJwNtCTuo06PSr34',
    '2026-9': '1yrKFbSVd6fCVjyw-nTxhpbSTsPo-0ibgxqEbiI_GgQc',
    '2026-10': '1-zpiBYsLqnzXUTGVSR4R0WkmWQ8dXavLjmCDhfkiDdE',
    '2026-11': '1iwFvdvTshjpZOMO2YzfQw6FUJYGM8fP6_2MO4JsqaRk',
    '2026-12': '1tMKv7LFEoEBcx7ial_T_0GRPQnqajhqnoNI4rFnB-5k'
};

// Employee QR mapping
const EMPLOYEES = {
    'Cassandra-7UVPYdf2XR594Zpe': 'Cassandra',
    'Ethan-Chuu-Gpc23kQxF8Z9tB17': 'Ethan Chuu',
    'Victor-So-R4CwQ2ZY9NvbDhST': 'Victor So',
    'Albert-nX4G9VmZ8eH2CLaD': 'Albert',
    'Aung-Thant-P3JdM6KQ4BqvARZ5': 'Aung Thant',
    'Bunyau-wZ2sF8mP1HkQ3DVL': 'Bunyau',
    'Chin-Sau-Ying-Q9T2gA5XvM8JZb4c': 'Chin Sau Ying',
    'Edika-LrF7W6eZV4sC3PN5': 'Edika',
    'Han-Lin-Maung-8DqZKT9WHXQpM32A': 'Han Lin Maung',
    'Lee-Lung-Chay-C4VZsT2m76gYLRN1': 'Lee Lung Chay',
    'Luna-tXq4m89P3bKZHEVg': 'Luna',
    'Myo-Min-Naing-2XQVf9cDyPWL7M8k': 'Myo Min Naing',
    'Peter-Seah-a9CZTq73r4XHB8nG': 'Peter Seah',
    'Piang-Soe-K7s4pP98tV2HGDJx': 'Piang Soe',
    'Terrence-MZC4nsp8B6L1y2F9': 'Terrence',
    'Wai-Phyo-f3XvGMkQ6NDTWP98': 'Wai Phyo',
    'William-Choo-Y62T4PH9NVxAEZ3k': 'William Choo',
    'Wong-Chok-Poh-sD7VAX4pW1fheN92': 'Wong Chok Poh',
    'Jessie-Tew-H8C2GNPaX1DLRQtv': 'Jessie Tew',
    'Shirley-Tew-WN6AsPeKZC97fqB3': 'Shirley Tew',
    'Cyril-ZYLfM3Bv859aDRcQ': 'Cyril',
    'Ocean-Chuu-T24pkC8M9GZ6NWAV': 'Ocean Chuu',
    'Kuan-3x8BRtq6EQfMPSHd': 'Kuan',
    'Ghan-bT7EYUd6QRgsC4Vk': 'Ghan',
    'Grace-L59ZQj8SnPYB2vWX': 'Grace',
    'Ko-Gyi-sPTZ1Vg6YxJWhb8k': 'Ko Gyi',
    'Zue-Hlang-Htoo-V3CSX4qL8K9WuZte': 'Zue Hlang Htoo',
    'Tun-Myint-Aung-Q7AfJNbXzt3EVc46': 'Tun Myint Aung'
};

// Global variables
let currentAdmin = null;
let qrScannerActive = false;
let videoStream = null;
let scannerContext = null;
let currentQRDataUrl = null;
let duplicateCheckData = null;
let trailingSpaceFields = [];
let isSpecialDuplicate = false;

document.addEventListener('DOMContentLoaded', function() {
    updateDateInfo();
    updateUnitOptions();
    
    // Set today's date as default for estimated delivery
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('estimatedDelivery').value = today;
    
    // Add event listener to unit select
    document.getElementById('unit').addEventListener('change', validateUnit);
});

// QR Scanner Functions
async function startQRScanner() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment" } 
        });
        
        videoStream = stream;
        document.getElementById('scannerVideo').srcObject = stream;
        document.getElementById('scannerOverlay').classList.add('hidden');
        document.getElementById('stopScanner').style.display = 'block';
        qrScannerActive = true;
        
        document.getElementById('scannerVideo').play();
        
        scannerContext = document.getElementById('scannerCanvas').getContext('2d', { willReadFrequently: true });
        requestAnimationFrame(scanQRCode);
    } catch (err) {
        alert("Unable to access camera. Please check permissions.");
        console.error("Camera error:", err);
    }
}

function scanQRCode() {
    if (!qrScannerActive || !scannerContext) return;
    
    const scannerVideo = document.getElementById('scannerVideo');
    const scannerCanvas = document.getElementById('scannerCanvas');
    
    if (scannerVideo.readyState === scannerVideo.HAVE_ENOUGH_DATA) {
        scannerCanvas.height = scannerVideo.videoHeight;
        scannerCanvas.width = scannerVideo.videoWidth;
        
        scannerContext.drawImage(scannerVideo, 0, 0, scannerCanvas.width, scannerCanvas.height);
        
        try {
            const imageData = scannerContext.getImageData(0, 0, scannerCanvas.width, scannerCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            
            if (code) {
                processScannedQR(code.data);
                stopQRScanner();
            }
        } catch (error) {
            console.warn('Error scanning QR code:', error);
        }
    }
    
    if (qrScannerActive) {
        requestAnimationFrame(scanQRCode);
    }
}

function processScannedQR(qrData) {
    try {
        const url = new URL(qrData);
        const pathParts = url.pathname.split('/').filter(p => p);
        
        if (pathParts.length > 0) {
            const employeeKey = pathParts[0];
            
            if (EMPLOYEES[employeeKey]) {
                currentAdmin = {
                    name: EMPLOYEES[employeeKey],
                    qrUrl: qrData,
                    key: employeeKey
                };
                
                document.getElementById('adminNameDisplay').textContent = currentAdmin.name;
                document.getElementById('adminWelcome').style.display = 'block';
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('adminName').value = currentAdmin.name;
                document.getElementById('adminQR').value = currentAdmin.qrUrl;
                
                showStatus('‚úÖ Admin authenticated: ' + currentAdmin.name, 'success');
            } else {
                showStatus('‚ùå Invalid employee QR code', 'error');
            }
        } else {
            showStatus('‚ùå Invalid QR code format', 'error');
        }
    } catch (error) {
        showStatus('‚ùå Error processing QR code: ' + error.message, 'error');
    }
}

function stopQRScanner() {
    qrScannerActive = false;
    if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
    }
    document.getElementById('scannerVideo').srcObject = null;
    document.getElementById('scannerOverlay').classList.remove('hidden');
    document.getElementById('stopScanner').style.display = 'none';
}

// Date Functions
function updateDateInfo() {
    const now = new Date();
    const monthYear = now.toLocaleString('en-US', { month: 'long', year: 'numeric' });
    const month = now.getMonth() + 1;
    const year = now.getFullYear();
    const key = `${year}-${month}`;
    const sheetId = WORKFLOW_SHEETS[key];
    
    document.getElementById('currentMonth').textContent = `Current Month: ${monthYear}`;
    
    if (sheetId) {
        document.getElementById('workflowInfo').innerHTML = 
            `Data will be saved to: <strong>${year} Work Flow ${month}</strong>`;
        
        document.getElementById('month').value = month;
        document.getElementById('year').value = year;
        document.getElementById('workflowSheetId').value = sheetId;
        document.getElementById('sheetId').value = sheetId;
    } else {
        document.getElementById('workflowInfo').textContent = 
            'No Google Sheet found for current month';
    }
}

// NEW: Handle Sales Order Type (R&D, Stock, or Sample)
function handleSalesOrderType() {
    const salesOrderInput = document.getElementById('salesOrder');
    const soValue = salesOrderInput.value.trim();
    const soTypeInfo = document.getElementById('soTypeInfo');
    
    // Remove previous styling
    salesOrderInput.classList.remove('rd-field', 'stock-field', 'sample-field');
    soTypeInfo.style.display = 'none';
    
    if (soValue === '999999') {
        salesOrderInput.classList.add('rd-field');
        soTypeInfo.innerHTML = 'üî¨ <strong>R&D Mode</strong> - Item No. will be checked against 2026 R&D List';
        soTypeInfo.style.display = 'block';
        soTypeInfo.style.borderLeftColor = 'var(--rd-green)';
    } else if (soValue === '000000') {
        salesOrderInput.classList.add('stock-field');
        soTypeInfo.innerHTML = 'üì¶ <strong>Stock Mode</strong> - Item No. will be checked against 2026 Stock List';
        soTypeInfo.style.display = 'block';
        soTypeInfo.style.borderLeftColor = 'var(--stock-blue)';
    } else if (soValue === '888888') {
        salesOrderInput.classList.add('sample-field');
        soTypeInfo.innerHTML = 'üß™ <strong>Sample Mode</strong> - Item No. will be checked against 2026 Sample List';
        soTypeInfo.style.display = 'block';
        soTypeInfo.style.borderLeftColor = 'var(--sample-purple)';
    }
}

// NEW: Check and auto-fill next Item No. for R&D/Stock/Sample
async function checkSpecialItemNo() {
    const salesOrder = document.getElementById('salesOrder').value.trim();
    const itemNoInput = document.getElementById('itemNo');
    const autoItemInfo = document.getElementById('autoItemInfo');
    
    // Remove previous styling
    itemNoInput.classList.remove('rd-field', 'stock-field', 'sample-field');
    autoItemInfo.style.display = 'none';
    
    if (salesOrder === '999999' || salesOrder === '000000' || salesOrder === '888888') {
        try {
            // Show loading
            autoItemInfo.innerHTML = '‚è≥ Getting next Item No...';
            autoItemInfo.style.display = 'block';
            autoItemInfo.style.borderLeftColor = 'var(--warning-orange)';
            
            // Call GAS to get next item number
            const response = await fetch(`${GAS_URL}?action=getNextItemNo&salesOrder=${encodeURIComponent(salesOrder)}`);
            const result = await response.json();
            
            if (result.success && result.data) {
                const nextItemNo = result.data.nextItemNo;
                const lastItemNo = result.data.lastItemNo;
                const listName = result.data.listName;
                
                // Style the Item No. field
                if (salesOrder === '999999') {
                    itemNoInput.classList.add('rd-field');
                    autoItemInfo.style.borderLeftColor = 'var(--rd-green)';
                } else if (salesOrder === '000000') {
                    itemNoInput.classList.add('stock-field');
                    autoItemInfo.style.borderLeftColor = 'var(--stock-blue)';
                } else if (salesOrder === '888888') {
                    itemNoInput.classList.add('sample-field');
                    autoItemInfo.style.borderLeftColor = 'var(--sample-purple)';
                }
                
                // Show info message
                if (lastItemNo) {
                    autoItemInfo.innerHTML = 
                        `üìã <strong>${listName}</strong><br>` +
                        `Last Item No.: ${lastItemNo}<br>` +
                        `Suggested next: <strong>${nextItemNo}</strong>`;
                } else {
                    autoItemInfo.innerHTML = 
                        `üìã <strong>${listName}</strong><br>` +
                        `Starting with: <strong>${nextItemNo}</strong>`;
                }
                
                // Auto-fill if field is empty
                if (!itemNoInput.value.trim()) {
                    itemNoInput.value = nextItemNo;
                    validateItemNoOnBlur();
                    updateCombinedCounter();
                }
                
                autoItemInfo.style.display = 'block';
            }
        } catch (error) {
            console.error('Error getting next item number:', error);
            autoItemInfo.innerHTML = '‚ö†Ô∏è Error getting next Item No.';
            autoItemInfo.style.display = 'block';
            autoItemInfo.style.borderLeftColor = 'var(--error-red)';
        }
    }
}

// NEW: Validate trailing spaces - ÈÄöÁî®ÁâàÊú¨
function validateTrailingSpaces(inputElement, fieldName, showAlert = false) {
    const value = inputElement.value;
    const trimmedValue = value.trim();
    
    if (value !== trimmedValue) {
        inputElement.classList.add('trailing-space-highlight');
        
        if (showAlert && !trailingSpaceFields.includes(fieldName)) {
            trailingSpaceFields.push(fieldName);
        }
        
        return false;
    } else {
        inputElement.classList.remove('trailing-space-highlight');
        return true;
    }
}

// NEW: Validate Sales Order No. trailing space specifically
function validateSalesOrderTrailingSpace(inputElement, showAlert = false) {
    const value = inputElement.value;
    const trimmedValue = value.trim();
    
    if (value !== trimmedValue) {
        inputElement.classList.add('trailing-space-highlight');
        
        if (showAlert && !trailingSpaceFields.includes('Sales Order No.')) {
            trailingSpaceFields.push('Sales Order No.');
        }
        
        return false;
    } else {
        inputElement.classList.remove('trailing-space-highlight');
        return true;
    }
}

// NEW: Validate Item No. trailing space specifically
function validateItemNoTrailingSpace(inputElement, showAlert = false) {
    const value = inputElement.value;
    const trimmedValue = value.trim();
    
    if (value !== trimmedValue) {
        inputElement.classList.add('trailing-space-highlight');
        
        if (showAlert && !trailingSpaceFields.includes('Item No.')) {
            trailingSpaceFields.push('Item No.');
        }
        
        return false;
    } else {
        inputElement.classList.remove('trailing-space-highlight');
        return true;
    }
}

// NEW: Show trailing space modal
function showTrailingSpaceModal() {
    const fieldsList = document.getElementById('trailingSpaceFields');
    fieldsList.innerHTML = '';
    
    trailingSpaceFields.forEach(field => {
        const li = document.createElement('li');
        li.textContent = field;
        li.style.marginBottom = '5px';
        fieldsList.appendChild(li);
    });
    
    document.getElementById('trailingSpaceModal').style.display = 'flex';
}

// NEW: Auto-fix trailing spaces
function autoFixTrailingSpaces() {
    // Fix Sales Order No.
    const salesOrderInput = document.getElementById('salesOrder');
    salesOrderInput.value = salesOrderInput.value.trim();
    salesOrderInput.classList.remove('trailing-space-highlight');
    
    // Fix Item No.
    const itemNoInput = document.getElementById('itemNo');
    itemNoInput.value = itemNoInput.value.trim();
    itemNoInput.classList.remove('trailing-space-highlight');
    
    // Fix Item Name (Main)
    const itemNameMainInput = document.getElementById('itemNameMain');
    itemNameMainInput.value = itemNameMainInput.value.trim();
    itemNameMainInput.classList.remove('trailing-space-highlight');
    
    // Fix Customer Name
    const customerNameInput = document.getElementById('customerName');
    customerNameInput.value = customerNameInput.value.trim();
    customerNameInput.classList.remove('trailing-space-highlight');
    
    // Close modal
    document.getElementById('trailingSpaceModal').style.display = 'none';
    trailingSpaceFields = [];
    
    // Continue with submission
    continueWithSubmission();
}

// NEW: Manual fix
function manualFixTrailingSpaces() {
    document.getElementById('trailingSpaceModal').style.display = 'none';
    trailingSpaceFields = [];
    
    // Highlight fields for manual fixing (all 4 fields that form tab name)
    const fields = ['salesOrder', 'itemNo', 'itemNameMain', 'customerName'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field.value.trim() !== field.value) {
            field.focus();
            field.select();
        }
    });
    
    showStatus('‚ö†Ô∏è Please fix the highlighted fields with trailing spaces', 'warning');
}

// NEW: Force submit with spaces
function forceSubmitWithSpaces() {
    document.getElementById('trailingSpaceModal').style.display = 'none';
    trailingSpaceFields = [];
    continueWithSubmission(true);
}

// Form Validation Functions
function validateSalesOrderOnBlur() {
    const input = document.getElementById('salesOrder');
    const value = input.value.trim();
    
    if (value === '') {
        input.classList.remove('valid', 'invalid');
        return true;
    }
    
    // Allow special R&D, Stock, and Sample numbers
    if (value === '999999' || value === '000000' || value === '888888') {
        input.classList.add('valid');
        input.classList.remove('invalid');
        return true;
    }
    
    const regex = /^\d{6}[A-Z]?$/;
    
    if (regex.test(value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
        return true;
    } else {
        input.classList.add('invalid');
        input.classList.remove('valid');
        alert('Invalid Sales Order No. format.\n\nPlease enter:\n‚Ä¢ 6 digits (e.g., 009999)\n‚Ä¢ OR 6 digits + 1 uppercase letter (e.g., 009999A)\n‚Ä¢ OR 999999 for R&D\n‚Ä¢ OR 000000 for Stock\n‚Ä¢ OR 888888 for Sample\n\nExamples: 123456, 123456A, 999999, 000000, 888888');
        return false;
    }
}

function validateItemNoOnBlur() {
    const input = document.getElementById('itemNo');
    const value = input.value.trim();
    
    if (value === '') {
        input.classList.remove('valid', 'invalid');
        return true;
    }
    
    const regex = /^\d+[A-Za-z]?$/;
    
    if (regex.test(value) && !/^[A-Za-z]/.test(value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
        return true;
    } else {
        input.classList.add('invalid');
        input.classList.remove('valid');
        alert('Invalid Item No. format.\n\nPlease enter:\n‚Ä¢ Numbers only (e.g., 100)\n‚Ä¢ OR Numbers + 1 letter at the end (e.g., 100A)\n\nNot allowed: A100, A, or other formats');
        return false;
    }
}

function validateQuantityOnBlur() {
    const input = document.getElementById('quantity');
    const value = input.value.trim();
    
    if (value === '') {
        input.classList.remove('valid', 'invalid');
        return true;
    }
    
    const regex = /^\d+$/;
    
    if (regex.test(value)) {
        input.classList.add('valid');
        input.classList.remove('invalid');
        return true;
    } else {
        input.classList.add('invalid');
        input.classList.remove('valid');
        alert('Invalid Quantity format.\n\nPlease enter:\n‚Ä¢ Numbers only (e.g., 100)\n\nNot allowed: letters or special characters');
        return false;
    }
}

function validateShortName() {
    const input = document.getElementById('customerShortName');
    const value = input.value;
    const counter = document.getElementById('shortNameCounter');
    
    counter.textContent = value.length;
    
    const regex = /^[A-Za-z0-9]{0,7}$/;
    
    if (!regex.test(value)) {
        input.value = value.replace(/[^A-Za-z0-9]/g, '').substring(0, 7);
        counter.textContent = input.value.length;
    }
    
    if (value.length > 7) {
        input.value = value.substring(0, 7);
        counter.textContent = 7;
    }
    
    if (value.length <= 7 && value.length > 0) {
        input.classList.add('valid');
        input.classList.remove('invalid');
    } else if (value.length === 0) {
        input.classList.remove('valid', 'invalid');
    } else {
        input.classList.add('invalid');
        input.classList.remove('valid');
    }
}

function updateUnitOptions() {
    const quantityInput = document.getElementById('quantity');
    const unitSelect = document.getElementById('unit');
    const quantityValue = quantityInput.value.trim();
    
    const quantityMatch = quantityValue.match(/\d+/);
    const quantity = quantityMatch ? parseInt(quantityMatch[0]) : 0;
    
    unitSelect.innerHTML = '<option value="">Select Unit</option>';
    
    let units = [];
    
    if (quantity === 1) {
        units = [
            { value: 'UNIT', text: 'Unit' },
            { value: 'PAIR', text: 'Pair' },
            { value: 'SET', text: 'Set' }
        ];
    } else if (quantity > 1) {
        units = [
            { value: 'UNITS', text: 'Units' },
            { value: 'PAIRS', text: 'Pairs' },
            { value: 'SETS', text: 'Sets' }
        ];
    } else {
        units = [
            { value: 'UNIT', text: 'Unit' },
            { value: 'PAIR', text: 'Pair' },
            { value: 'SET', text: 'Set' },
            { value: 'UNITS', text: 'Units' },
            { value: 'PAIRS', text: 'Pairs' },
            { value: 'SETS', text: 'Sets' }
        ];
    }
    
    units.forEach(unit => {
        const option = document.createElement('option');
        option.value = unit.value;
        option.textContent = unit.text;
        unitSelect.appendChild(option);
    });
}

function validateUnit() {
    const unitField = document.getElementById('unit');
    if (unitField.value !== '') {
        unitField.classList.remove('invalid');
        unitField.classList.add('valid');
    } else {
        unitField.classList.remove('valid');
    }
}

function updateCombinedCounter() {
    const salesOrder = document.getElementById('salesOrder').value;
    const customerName = document.getElementById('customerName').value;
    const itemNo = document.getElementById('itemNo').value;
    const itemNameMain = document.getElementById('itemNameMain').value;
    
    const combinedLength = salesOrder.length + customerName.length + itemNo.length + itemNameMain.length;
    const combinedCounter = document.getElementById('combinedCounter');
    const combinedChars = document.getElementById('combinedChars');
    
    combinedChars.textContent = combinedLength;
    
    // Update individual counters
    document.getElementById('salesOrderCombinedCounter').textContent = `${salesOrder.length} chars`;
    document.getElementById('customerNameCombinedCounter').textContent = `${customerName.length} chars`;
    document.getElementById('itemNoCombinedCounter').textContent = `${itemNo.length} chars`;
    document.getElementById('itemNameCombinedCounter').textContent = `${itemNameMain.length} chars`;
    
    if (combinedLength > 90) {
        combinedCounter.className = 'char-counter error';
        combinedCounter.innerHTML = 
            `‚ö†Ô∏è Combined characters: <span id="combinedChars">${combinedLength}</span>/90 - Exceeds Google Sheets tab name limit!`;
    } else if (combinedLength > 80) {
        combinedCounter.className = 'char-counter warning';
        combinedCounter.innerHTML = 
            `‚ö†Ô∏è Combined characters: <span id="combinedChars">${combinedLength}</span>/90 - Close to limit`;
    } else {
        combinedCounter.className = 'char-counter';
        combinedCounter.innerHTML = 
            `Combined characters (SO + Customer + ItemNo + ItemMain): <span id="combinedChars">${combinedLength}</span>/90`;
    }
}

function validateCurrency() {
    const myr = document.getElementById('myr').value;
    const sgd = document.getElementById('sgd').value;
    
    const myrInput = document.getElementById('myr');
    const sgdInput = document.getElementById('sgd');
    
    myrInput.classList.remove('valid', 'invalid');
    sgdInput.classList.remove('valid', 'invalid');
    
    if (myr || sgd) {
        if (myr) {
            myrInput.classList.add('valid');
        }
        if (sgd) {
            sgdInput.classList.add('valid');
        }
        if (myr && sgd) {
            showStatus('‚ö†Ô∏è Please fill only MYR OR SGD, not both', 'info');
        }
        return true;
    }
    
    return false;
}

// Calendar Functions
function openCalendar() {
    const modal = document.getElementById('calendarModal');
    const currentDate = document.getElementById('estimatedDelivery').value;
    
    document.getElementById('modalDatePicker').value = currentDate;
    modal.style.display = 'flex';
}

function closeCalendar() {
    document.getElementById('calendarModal').style.display = 'none';
}

function applyCalendarDate() {
    const selectedDate = document.getElementById('modalDatePicker').value;
    document.getElementById('estimatedDelivery').value = selectedDate;
    closeCalendar();
}

// QR Generation Function using qrcode library
function generateQRInHTML() {
    const salesOrder = document.getElementById('salesOrder').value.trim();
    const itemNo = document.getElementById('itemNo').value.trim();
    const soNumber = salesOrder.startsWith('SO-') ? salesOrder : 'SO-' + salesOrder;
    
    // Generate base64 encoded string for H parameter
    const combinedString = `${soNumber}&${itemNo}`;
    const base64Encoded = btoa(combinedString);
    
    // Generate OET URL with base64 encoded H parameter
    const oetURL = `https://hl-steel-industries-sdn-bhd.github.io/Drawing-QR-Template/?H=${base64Encoded}`;
    
    // Update hidden fields for GAS
    document.getElementById('generatedQR').value = oetURL;
    document.getElementById('qrFileName').value = `${soNumber.replace('SO-', '')}-${itemNo}.png`;
    
    // Update QR info display
    document.getElementById('qrInfo').innerHTML = `
        <strong>URL:</strong><br>
        <code style="font-size: 12px;">${oetURL}</code><br><br>
        <strong>File Name:</strong><br>
        ${soNumber.replace('SO-', '')}-${itemNo}.png<br><br>
        <strong>Note:</strong> QR also saved to Google Drive
    `;
    
    // Hide placeholder
    document.getElementById('qrPlaceholder').style.display = 'none';
    
    // Generate QR code using qrcode library
    const canvas = document.getElementById('qrCodeCanvas');
    
    // Clear canvas
    const ctx = canvas.getContext('2d');
    canvas.width = 250;
    canvas.height = 250;
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, 250, 250);
    
    // Generate QR code
    QRCode.toCanvas(canvas, oetURL, {
        width: 230,
        margin: 2,
        color: {
            dark: '#000000',
            light: '#FFFFFF'
        }
    }, function(error) {
        if (error) {
            console.error('QR generation error:', error);
            // Fallback: Draw text
            ctx.fillStyle = '#000000';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('QR Code for:', 125, 100);
            ctx.fillText(oetURL.substring(0, 30), 125, 120);
            ctx.fillText(oetURL.substring(30), 125, 140);
        } else {
            // Success - enable download button
            document.getElementById('downloadQR').disabled = false;
            currentQRDataUrl = canvas.toDataURL('image/png');
        }
    });
}

// Download QR Code
function downloadQRCode() {
    if (!currentQRDataUrl) return;
    
    // Create temporary link for download
    const link = document.createElement('a');
    const salesOrder = document.getElementById('salesOrder').value.trim();
    const itemNo = document.getElementById('itemNo').value.trim();
    const soNumber = salesOrder.startsWith('SO-') ? salesOrder : 'SO-' + salesOrder;
    
    link.href = currentQRDataUrl;
    link.download = `${soNumber.replace('SO-', '')}-${itemNo}.png`;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Form Submission Functions
async function prepareAndSubmitForm(event) {
    event.preventDefault();
    
    if (!validateForm()) {
        return false;
    }
    
    if (!currentAdmin) {
        showStatus('‚ùå Please scan your Admin QR code first', 'error');
        return false;
    }
    
    // Check for trailing spaces
    trailingSpaceFields = [];
    
    // Validate trailing spaces for all 4 fields that form tab name
    const itemNameMainValid = validateTrailingSpaces(document.getElementById('itemNameMain'), 'Item Name (Main)', true);
    const customerNameValid = validateTrailingSpaces(document.getElementById('customerName'), 'Customer Name', true);
    const salesOrderValid = validateSalesOrderTrailingSpace(document.getElementById('salesOrder'), true);
    const itemNoValid = validateItemNoTrailingSpace(document.getElementById('itemNo'), true);
    
    if (trailingSpaceFields.length > 0) {
        showTrailingSpaceModal();
        return false;
    }
    
    // Show loading status
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = 'status-message loading';
    statusDiv.innerHTML = '‚è≥ Checking for duplicates...';
    statusDiv.style.display = 'block';
    
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = 'Checking...';
    
    try {
        // First, check for duplicates
        const duplicateResult = await checkForDuplicates();
        
        if (duplicateResult.duplicate) {
            // Show duplicate confirmation modal
            showDuplicateModal(duplicateResult);
            return false;
        } else {
            // No duplicate found, proceed with submission
            continueWithSubmission();
        }
    } catch (error) {
        console.error('Error in duplicate checking:', error);
        // If duplicate check fails, proceed with submission anyway
        showStatus('‚ö†Ô∏è Duplicate check failed, proceeding with submission...', 'info');
        setTimeout(() => {
            continueWithSubmission();
        }, 2000);
    }
    
    return true;
}

// Continue with submission after all checks
function continueWithSubmission(forceSubmit = false) {
    // Show loading status
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = 'status-message loading';
    statusDiv.innerHTML = forceSubmit ? 
        '‚è≥ Force submitting data...' : 
        '‚è≥ Processing and saving data...';
    statusDiv.style.display = 'block';
    
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = 'Processing...';
    
    // Generate QR in HTML (instant display)
    generateQRInHTML();
    
    // Prepare timestamp in correct format (YYYY-MM-DD HH:MM:SS)
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    
    const timestamp = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    document.getElementById('timestamp').value = timestamp;
    
    // Add force submit flag to hidden field
    const forceSubmitInput = document.createElement('input');
    forceSubmitInput.type = 'hidden';
    forceSubmitInput.name = 'forceSubmit';
    forceSubmitInput.value = forceSubmit ? 'true' : 'false';
    document.getElementById('salesForm').appendChild(forceSubmitInput);
    
    // Set form action and submit
    const form = document.getElementById('salesForm');
    form.action = GAS_URL;
    
    // Submit form via iframe (no CORS)
    form.submit();
    
    // Set up polling to check iframe result (optional)
    setTimeout(() => {
        checkSubmissionResult(forceSubmit);
    }, 3000);
}

// Function to check for duplicates
async function checkForDuplicates() {
    const salesOrder = document.getElementById('salesOrder').value.trim();
    const itemNo = document.getElementById('itemNo').value.trim();
    
    if (!salesOrder || !itemNo) {
        return { duplicate: false, error: 'Sales Order or Item No. is empty' };
    }
    
    // Prepare data for duplicate check
    duplicateCheckData = {
        salesOrder: salesOrder,
        itemNo: itemNo
    };
    
    // Call GAS to check for duplicates via GET request
    const gasUrl = `${GAS_URL}?action=checkDuplicate&salesOrder=${encodeURIComponent(salesOrder)}&itemNo=${encodeURIComponent(itemNo)}`;
    
    try {
        const response = await fetch(gasUrl);
        const result = await response.json();
        return result;
    } catch (error) {
        console.error('Error checking duplicates:', error);
        return { duplicate: false, error: error.message };
    }
}

// Function to show duplicate modal
function showDuplicateModal(duplicateResult) {
    // Populate modal with data
    document.getElementById('duplicateSalesOrder').textContent = duplicateResult.salesOrder || 'Unknown';
    document.getElementById('duplicateItemNo').textContent = duplicateResult.itemNo || 'Unknown';
    
    // Extract SO base number (remove trailing letter)
    const soRaw = duplicateCheckData.salesOrder;
    const soBase = soRaw.replace(/[A-Z]$/, '');
    document.getElementById('duplicateCombination').textContent = `${soBase} + ${duplicateCheckData.itemNo}`;
    
    // Check if it's a special type duplicate (R&D/Stock/Sample)
    if (duplicateResult.specialDuplicate) {
        document.getElementById('duplicateModalTitle').textContent = `‚ö†Ô∏è Duplicate in ${duplicateResult.listName}`;
        document.getElementById('duplicateModalMessage').textContent = duplicateResult.message;
        document.getElementById('duplicateListInfo').style.display = 'block';
        document.getElementById('duplicateListName').textContent = duplicateResult.listName;
        
        let noteText = '';
        if (duplicateResult.type === 'R&D') {
            noteText = 'Note: R&D (999999) items must have unique Item Nos.';
        } else if (duplicateResult.type === 'Stock') {
            noteText = 'Note: Stock (000000) items must have unique Item Nos.';
        } else if (duplicateResult.type === 'Sample') {
            noteText = 'Note: Sample (888888) items must have unique Item Nos.';
        }
        
        document.getElementById('duplicateNote').innerHTML = 
            `<span style="font-size: 20px; margin-right: 5px;">‚ìò</span>${noteText}`;
        
        isSpecialDuplicate = true;
    } else {
        document.getElementById('duplicateModalTitle').textContent = '‚ö†Ô∏è Duplicate Entry Found';
        document.getElementById('duplicateModalMessage').textContent = 'The following combination already exists in the Collection of Operational Entry Form:';
        document.getElementById('duplicateListInfo').style.display = 'none';
        document.getElementById('duplicateNote').innerHTML = 
            '<span style="font-size: 20px; margin-right: 5px;">‚ìò</span>' +
            'Note: SO numbers with different trailing letters (e.g., 009999 and 009999A) are considered the same.';
        isSpecialDuplicate = false;
    }
    
    // Show modal
    document.getElementById('duplicateModal').style.display = 'flex';
    
    // Reset button
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').innerHTML = 'Submit Drawing Information';
    
    // Hide status message
    document.getElementById('statusMessage').style.display = 'none';
}

// Function to force submit entry
function forceSubmitEntry() {
    // Hide modal
    document.getElementById('duplicateModal').style.display = 'none';
    
    // Continue with force submission
    continueWithSubmission(true);
}

// Function to cancel duplicate submission
function cancelDuplicateSubmission() {
    // Hide modal
    document.getElementById('duplicateModal').style.display = 'none';
    
    // Reset form to original state (not full reset)
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').innerHTML = 'Submit Drawing Information';
    
    // Show info message
    let message;
    if (isSpecialDuplicate) {
        const salesOrder = document.getElementById('salesOrder').value.trim();
        if (salesOrder === '999999') {
            message = '‚ùå Submission cancelled. Item No. already exists in R&D list.';
        } else if (salesOrder === '000000') {
            message = '‚ùå Submission cancelled. Item No. already exists in Stock list.';
        } else if (salesOrder === '888888') {
            message = '‚ùå Submission cancelled. Item No. already exists in Sample list.';
        }
    } else {
        message = '‚ùå Submission cancelled. Entry already exists in Collection.';
    }
    
    showStatus(message, 'info');
    
    // Highlight the problematic fields
    highlightDuplicateFields();
}

// Function to highlight duplicate fields
function highlightDuplicateFields() {
    const fields = ['salesOrder', 'itemNo'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.classList.add('invalid');
        field.style.borderColor = '#e74c3c';
        field.style.boxShadow = '0 0 0 2px rgba(231, 76, 60, 0.1)';
    });
    
    // Reset highlighting after 5 seconds
    setTimeout(() => {
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.classList.remove('invalid');
            field.style.borderColor = '';
            field.style.boxShadow = '';
        });
    }, 5000);
}

// Function to check submission result (optional enhancement)
function checkSubmissionResult(forceSubmitted) {
    const statusDiv = document.getElementById('statusMessage');
    
    // Reset button
    document.getElementById('submitBtn').disabled = false;
    document.getElementById('submitBtn').innerHTML = 'Submit Drawing Information';
    
    // Show success message
    if (forceSubmitted) {
        statusDiv.className = 'status-message success';
        statusDiv.innerHTML = '‚úÖ Entry force submitted successfully! (Duplicate entry)';
    } else {
        statusDiv.className = 'status-message success';
        statusDiv.innerHTML = '‚úÖ Data submitted successfully!';
    }
    
    // Remove force submit input if it exists
    const forceSubmitInput = document.querySelector('input[name="forceSubmit"]');
    if (forceSubmitInput) {
        forceSubmitInput.remove();
    }
    
    // Hide message after 5 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function validateForm() {
    const requiredFields = [
        'salesOrder', 'customerName', 'customerShortName', 
        'itemNo', 'itemNameMain', 'dimension', 'quantity', 'unit'
    ];
    
    let isValid = true;
    let errorMessage = '';
    
    // Clear all validation styles first
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.classList.remove('invalid', 'valid');
    });
    
    for (const fieldId of requiredFields) {
        const field = document.getElementById(fieldId);
        const label = field.previousElementSibling.textContent.replace(' *', '');
        
        if (!field.value.trim()) {
            isValid = false;
            errorMessage += `‚Ä¢ ${label} is required\n`;
            field.classList.add('invalid');
        } else {
            field.classList.remove('invalid');
            field.classList.add('valid');
        }
    }
    
    const salesOrderField = document.getElementById('salesOrder');
    if (salesOrderField.value.trim() && !validateSalesOrderOnBlur()) {
        isValid = false;
        errorMessage += '‚Ä¢ Sales Order No. has invalid format\n';
    }
    
    const itemNoField = document.getElementById('itemNo');
    if (itemNoField.value.trim() && !validateItemNoOnBlur()) {
        isValid = false;
        errorMessage += '‚Ä¢ Item No. has invalid format\n';
    }
    
    const quantityField = document.getElementById('quantity');
    if (quantityField.value.trim() && !validateQuantityOnBlur()) {
        isValid = false;
        errorMessage += '‚Ä¢ Quantity has invalid format\n';
    }
    
    const shortName = document.getElementById('customerShortName').value;
    if (shortName.length > 7) {
        isValid = false;
        errorMessage += '‚Ä¢ Customer Short Name must be 7 characters or less\n';
    }
    
    const combinedLength = 
        document.getElementById('salesOrder').value.length +
        document.getElementById('customerName').value.length +
        document.getElementById('itemNo').value.length +
        document.getElementById('itemNameMain').value.length;
    
    if (combinedLength > 90) {
        isValid = false;
        errorMessage += '‚Ä¢ Combined character count exceeds 90 (Google Sheets tab name limit)\n';
    }
    
    const myr = document.getElementById('myr').value;
    const sgd = document.getElementById('sgd').value;
    
    if (!myr && !sgd) {
        isValid = false;
        errorMessage += '‚Ä¢ Please fill either MYR or SGD\n';
    }
    
    const unitField = document.getElementById('unit');
    if (unitField.value === '') {
        isValid = false;
        errorMessage += '‚Ä¢ Please select a Unit of Measurement\n';
        unitField.classList.add('invalid');
    } else {
        unitField.classList.remove('invalid');
        unitField.classList.add('valid');
    }
    
    if (!isValid) {
        alert('Please fix the following errors:\n\n' + errorMessage);
        showStatus('‚ùå Please fix form errors', 'error');
    }
    
    return isValid;
}

function resetForm() {
    document.getElementById('salesForm').reset();
    document.getElementById('statusMessage').style.display = 'none';
    
    currentAdmin = null;
    document.getElementById('adminWelcome').style.display = 'none';
    document.getElementById('submitBtn').disabled = true;
    
    // Show placeholder in center of QR display box
    document.getElementById('qrPlaceholder').style.display = 'flex';
    const canvas = document.getElementById('qrCodeCanvas');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    document.getElementById('downloadQR').disabled = true;
    document.getElementById('qrInfo').innerHTML = 'This QR links production workers to the operational entry form.<br><br>URL format: https://hl-steel-industries-sdn-bhd.github.io/Drawing-QR-Template/?H=<br><br><strong>Example:</strong><br>Full URL: https://hl-steel-industries-sdn-bhd.github.io/Drawing-QR-Template/?H=U08tODg4ODg4QSsyM0I=';
    
    const inputs = document.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.classList.remove('valid', 'invalid', 'rd-field', 'stock-field', 'sample-field', 'trailing-space-highlight');
    });
    
    // Reset special info displays
    document.getElementById('soTypeInfo').style.display = 'none';
    document.getElementById('autoItemInfo').style.display = 'none';
    
    updateCombinedCounter();
    updateDateInfo();
    updateUnitOptions();
    
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = 'Submit Drawing Information';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('estimatedDelivery').value = today;
    
    currentQRDataUrl = null;
    trailingSpaceFields = [];
    isSpecialDuplicate = false;
    
    // Reset individual counters
    document.getElementById('salesOrderCombinedCounter').textContent = '';
    document.getElementById('customerNameCombinedCounter').textContent = '';
    document.getElementById('itemNoCombinedCounter').textContent = '';
    document.getElementById('itemNameCombinedCounter').textContent = '';
    document.getElementById('shortNameCounter').textContent = '0';
}

function showStatus(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `status-message ${type}`;
    statusDiv.innerHTML = message;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}
</script>
</body>
</html>
